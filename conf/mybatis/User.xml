<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="User">

	<insert id="saveUser" parameterType="com.aztask.vo.User" useGeneratedKeys="true"	keyProperty="id" keyColumn="id">
	INSERT INTO t_user
	(name,
	phone,
	email,
	skills,
	device_id)
	VALUES
	(#{name},#{contact},#{email},#{skills},#{deviceId});
		<selectKey keyProperty="id" resultType="int" order="AFTER">
			SELECT	LAST_INSERT_ID();
		</selectKey>
	</insert>

  <select id="isUserRegistered" resultType="com.aztask.vo.User">
    select * from t_user where device_id = #{device_id}
  </select>

  <select id="getUserById" resultType="com.aztask.vo.User">
    select * from t_user where id = #{id}
  </select>
  
  <select id="getNearbyDevices" resultType="com.aztask.vo.NearByDevice" >

	<![CDATA[ SELECT device_id, (6371 * acos (cos ( radians(#{latitude}) ) * cos( radians(tul.latitude ) ) * 
	 		cos( radians(tul.longitude ) - radians(#{longitude}) )+sin ( radians(#{latitude}) ) * sin( radians(tul.latitude) ))) AS distance
	  		FROM t_user_loc tul having distance < 3 order by distance  ]]>
  </select>


  <select id="getRelatedNearbyUsers" resultType="com.aztask.vo.User">
		select * from t_user 
		 <where>#{longitude}</where>
  </select>

 <update id="updateUser">
 
 	update t_user set name=#{name},contact=#{contact},email=#{email},skills=#{skills} where device_id=#{deviceId}	
 
 </update>
  
  <select id="login_by_email" resultType="int">
  	select count(*) from t_user where email=#{email} and device_id=#{deviceId}
  </select>

  <select id="login_by_phone">
  	select count(*) from t_user
  </select>

  <select id="selectNearbyUsers" parameterType="java.util.Map" resultType="com.aztask.vo.User">
  	SELECT * FROM t_user WHERE device_id in ${deviceIds} and (${skills})
  </select>
  
  
</mapper>

